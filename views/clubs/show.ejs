<% include ../partials/header %>

<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<script src='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />


<div class="row no-gutters content-toppad">
  <div class="col-lg-9 order-md-first order-last">
    <div class="row no-gutters">
      <div class="col-md-12">
          <div class="row no-gutters">
            <div class="col-md-3 p-1 card coverback indexcard clubback avatar-frame lcov order-md-first order-last lpcov mx-auto">
              <div class="container">
                <img class="avatar cover image mx-auto" src="<%= club.avatar || '/images/noClub.png' %>">
                <% if(0 <= rank && rank <= 1){ %>
                  <form action="/clubs/<%= club._id %>?_method=PUT" method="POST" enctype="multipart/form-data">
                    <label for="inputavatar" class="overlay">
                      <i class="fas fa-upload"></i> Update club avatar
                    </label>
                    <input type="file" id="inputavatar" class="text-sm" name="avatar" accept="image/*" required>
                    <button class="btn btn-sm btn-success overlay2" onclick="loading_spinner('load-updateavatar','');"><span id="load-updateavatar"></span>Submit</button>
                  </form>
                <% } %>
              </div>
              <div>
                <h5 class="profilename"><%= club.name %></h5>
              </div>
            </div>
            <% if(club.featuredPhotos.length != 0){ %>
              <div class="col-md-9 p-1 card coverback clubback indexcard rcov">
            <% } else{ %>
              <div class="col-md-9 p-1 card coverback clubback indexcard rcov carousel-frame2">
            <% } %>
              <div id="carouselControls" class="carousel slide carousel-fade" data-ride="carousel">
                <% if(club.featuredPhotos.length == 0){ %>
                  <div class="carousel-inner d-flex">
                    <div class="carousel-item active carousel-div carousel-img">
                      <img class="cover mobile-cover" src="/images/noImage.png" style="opacity: 0;">
                    </div>
                  </div>
                <% } %>
                <% if(club.featuredPhotos.length != 0){ %>
                  <% if(club.featuredPhotos.length > 1){ %>
                    <ol class="carousel-indicators">
                      <% for(var i=0;i<club.featuredPhotos.length;i++){ %>
                        <li data-target="#carouselControls" data-slide-to="<%= i %>"></li>
                      <% } %>
                    </ol>
                  <% } %>
                  <div class="carousel-inner d-flex">
                    <% if(club.featuredPhotos.length >= 1){ %>
                      <div class="carousel-item active">
                        <img class="cover mobile-cover" src="<%= club.featuredPhotos[0].image %>">
                        <div class="carousel-caption">
                          <h6 class="carousel-caption-heading"><%= club.featuredPhotos[0].heading %></h6>
                          <div><%= club.featuredPhotos[0].description %></div>
                        </div>
                      </div>
                    <% } %>
                    <% if(club.featuredPhotos.length >= 2){ %>
                      <% for(var i=1;i<club.featuredPhotos.length;i++){ %>
                        <div class="carousel-item">
                          <img class="cover mobile-cover" src="<%= club.featuredPhotos[i].image %>">
                          <div class="carousel-caption">
                            <h6 class="carousel-caption-heading"><%= club.featuredPhotos[i].heading %></h6>
                            <div><%= club.featuredPhotos[i].description %></div>
                          </div>
                        </div>
                      <% } %>
                    <% } %>
                  </div>
                  <% if(club.featuredPhotos.length > 1){ %>
                    <a class="carousel-control carousel-control-prev" href="#carouselControls" role="button" data-slide="prev">
                      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                      <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control carousel-control-next" href="#carouselControls" role="button" data-slide="next">
                      <span class="carousel-control-next-icon" aria-hidden="true"></span>
                      <span class="sr-only">Next</span>
                    </a>
                  <% } %>
                  <% if(0 <= rank && rank <= 2){ %>
                    <a class="btn btnxs btn-secondary overlay3" href="/clubs/<%= club._id %>/featured_photos">Update featured photos</a>
                  <% } %>
                <% } else{ %>
                  <% if(0 <= rank && rank <= 2){ %>
                    <a class="btn btnxs btn-secondary overlay3 opaque" href="/clubs/<%= club._id %>/featured_photos">Update featured photos</a>
                  <% } %>
                <% } %>
              </div>
            </div>
          </div>
      </div>
      <div class="col-md-4 px-1 mobilepad mt-2 keys">
        <div class="card">
          <button id="drop-info" type="button" class="btn btn-sm boldtext btncollapse" data-toggle="collapse" data-target="#infobox">Info</button>
          <div id="infobox" class="collapse card-body5">
            <% if(currentUser){ %>
              <form action="/users/<%= currentUser._id %>/unfollow/<%= club._id %>?_method=PUT" method="POST">
                <div class="text-sm boldtext lightgrey my-3 text-center"><%= club.totalFollowerCount %></div>
                <!-- Member have to follow seperately too -->
                <div class="text-center my-3">
                  <!-- Follow (Stray) club whose orgPage/college is not followed by CU-->
                  <% if(!isFollowingOrg && !isFollowingStrayClub){ %>
                    <button class="btn btn-org2 orgdiv-follow py-1 px-2" name="followClubStray" value="true" type="submit">Follow</button>
                  <!-- Unfollow Stray club -->
                  <% } else if(!isFollowingOrg && isFollowingStrayClub){ %>
                    <button class="btn btn-light btn-org orgdiv-follow py-1 px-2" name="followClubStray" value="false" type="submit"><i class="fas fa-check"></i> Following</button>
                  <!-- Unfollow (Org) club whoose orgPage/college is followed by CU -->
                  <% } else if(isFollowingOrg && !isUnFollowingOrgClub){ %>
                    <button class="btn btn-light btn-org orgdiv-follow py-1 px-2" name="followClubOrg" value="false" type="submit"><i class="fas fa-minus"></i> Unfollow</button>
                  <!-- Follow Org Club -->
                  <% } else if(isFollowingOrg && isUnFollowingOrgClub){ %>
                    <button class="btn btn-org2 orgdiv-follow py-1 px-2" name="followClubOrg" value="true" type="submit">Follow again</button>
                  <% } %>
                </div>
              </form>
              <% if(isFollowingOrg){ %>
                  <em class="text-xs lightgrey2 mt-2">Following: <%= club.clubKeys.organization %></em>
                <% } %>
            <% } %>
            <div>
              <div class="text-sm my-2 boldtext lineheight"><%= club.banner %></div>
              <div class="valign">
                <div class="boldtext">Description</div>
                <% if(0 <= rank && rank <= 1){ %>
                  <div>
                    <button onclick="toggle_display('club_desc');" class="btn btn-sm dropdown-toggle"><i class="fas fa-edit"></i></button>
                  </div>
                <% } %>
              </div>
              <div class="text-sm linewrap lineheight mb-2"><%= club.info.description %></div>
              <% if(0 <= rank && rank <= 1){ %>
                <form id="club_desc" action="/clubs/<%= club._id %>?_method=PUT" method="POST">
                  <textarea class="form-control form-control-sm" type="text" name="info[description]" rows="10" required><%= club.info.description %></textarea>
                  <button class="btn btn-sm btn-primary btn-block mt-2" type="submit">Update description</button>
                </form>
              <% } %>
            </div>
            <div>
              <div class="valign">
                <div class="boldtext">Rules</div>
                <% if(0 <= rank && rank <= 1){ %>
                  <div>
                    <button onclick="toggle_display('club_rules');" class="btn btn-sm dropdown-toggle"><i class="fas fa-edit"></i></button>
                  </div>
                <% } %>
              </div>
              <div class="text-sm linewrap lineheight mb-2"><%= club.info.rules %></div>
              <% if(0 <= rank && rank <= 1){ %>
                <form id="club_rules" action="/clubs/<%= club._id %>?_method=PUT" method="POST">
                  <textarea class="form-control form-control-sm" type="text" name="info[rules]" rows="10" required><%= club.info.rules %></textarea>
                  <button class="btn btn-sm btn-primary btn-block mt-2" type="submit">Update rules</button>
                  <br>
                </form>
              <% } %>
            </div>
            <!-- Tags -->
            <div class="valign">
              <div class="boldtext">Discover tags</div>
              <% if(0 <= rank && rank <= 1){ %>
                <div>
                  <button onclick="toggle_display('tags_form_div');" class="btn btn-sm dropdown-toggle floatright nothing d-flex pt-1 pl-1 mb-auto"><i class="fas fa-edit"></i></button>
                </div>
              <% } %>
            </div>
            <div class="text-sm mb-2"><em><% if(club.clubKeys.tags && club.clubKeys.tags.length){tags_split(club.clubKeys.tags)} %></em></div>
            <div id="tags_form_div" class="greyback mb-2">
              <form class="form-inline d-flex justify-content-between mt-2 px-2" action="/clubs/<%= club._id %>?_method=PUT" method="POST">
                <% var tags = club.clubKeys.tags; %>
                  <% for(var i=0;i<10;i++){ %>
                    <% if(club.clubKeys.tags && club.clubKeys.tags.length){ %>
                      <input type="text" class="form-control form-control-sm info-form" name="clubKeys[tags]" placeholder="tag [<%= Number(i+1) %>]" value="<%= club.clubKeys.tags[i] %>">
                    <% } else{ %>
                      <input type="text" class="form-control form-control-sm info-form" name="clubKeys[tags]" placeholder="tag [<%= Number(i+1) %>]" value="">
                    <% } %>
                  <% } %>
                <br>
                <button class="btn btn-sm btnxs btn-primary d-flex ml-auto" type="submit">Update</button>
              </form>
            </div>
            <% if((club.clubKeys.location && club.clubKeys.location != '') && club.geometry){ %>
              <div>
                <div id='map' style="border: 1px solid lightgrey;"></div>
              </div>
            <% } else{ %>
              <hr>
            <% } %>
          </div>
          <div class="card-body">
            <div class="dropctn">
              <h5>Keys</h5>  
              <div class="dropdown">
                <% if(currentUser){ %>
                  <button class="btn btn-sm dropdown-toggle mb-1" type="button" data-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                <% } %>
                <ul class="dropdown-menu dropdown-menu-right dropbox">
                  <div class="container drop-shadow1">
                      <li><a class="dropitems text-sm" href="#">Help ?</a></li>
                    <% if(0 <= rank && rank <= 1){ %>
                      <li onclick="toggle_display('toggle_club_form');"><a class="dropitems text-sm" href="#">Edit club Keys</a></li>
                    <% } %>
                    <% if(rank == 0){ %>
                      <hr>
                      <li>
                        <button class="dropitems link-button red text-sm" href="#delClubModal<%= club._id %>" data-toggle="modal">
                          <span>Delete club</span>
                          <span><i class="fas fa-trash-alt"></i></span>
                        </button>
                      </li>
                    <% } %>
                  </div>
                </ul>
              </div>
              <% if(rank == 0){ %>
                <!-- Modal HTML -->
                <div id="delClubModal<%= club._id %>" class="fixed-padding modal fade">
                  <div class="modal-dialog modal-confirm">
                    <div class="modal-content">
                      <div class="d-flex">
                        <span class="icon-box">
                          <i class="fas fa-exclamation-triangle text-xxxl"></i>
                        </span>              
                        <span class="my-auto"><h5 class="modal-title">Are you sure?</h5></span>
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                      </div>
                      <div>
                        <p class="nothing">Do you really want to delete <%= club.name %>?</p>
                        <p>Posts created through this club might still appear in other places.</p>
                      </div>
                      <div class="my-2">
                        <button type="button" class="btn btn-secondary btn-sm mr-1" data-dismiss="modal">Cancel</button>
                        <form class="delete-form inline text-sm" action="/clubs/<%= club._id %>/delete?_method=PUT" method="POST">
                          <button class="btn btn-danger btn-sm ml-1" type="submit">Delete</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              <% } %>
            </div>
            <hr class="hr-light mobileNone">
            <div class="d-flex flex-column text-sm">
              <div class="info1">College: <div class="info30 boldtext"><a href="/org_pages/<%= club.clubKeys.organization %>"><%= club.clubKeys.organization %></a></div></div>
              <div class="info1">Category: <div class="info30"><a href="/find_clubs/filter_search?clubs=&location=&category=<%= club.clubKeys.category %>&organization="><%= club.clubKeys.category %></a></div></div>
              <% if(club.clubKeys.weblink){ %>
                <div class="info1">Weblink: <div class="info30"><a href="<%= club.clubKeys.weblink %>" target="_blank" rel="noopener"><%= club.clubKeys.weblink.replace(/^https?\:\/\//i, '') %></a></div></div>
              <% } %>
              <% if(club.clubKeys.location){ %>
                <div class="info1">Location: <div class="info30"><a href="/find_clubs/filter_search?clubs=&location=<%= club.clubKeys.location %>&category=&organization="><%= club.clubKeys.location %></a></div></div>
              <% } %>
            </div>
          </div>
          <% if(0 <= rank && rank <= 1){ %>
            <div id="toggle_club_form">
              <hr>
              <form class="form-signin" action="/clubs/<%= club._id %>?_method=PUT" method="POST">
                <label for="name" class="sr-only">Club name</label>
                <input type="text" id="name" class="form-control form-control-sm commentbox2 text-center greyback shadow mb-2" name="name" value="<%= club.name %>" placeholder="Club name">
                <label for="banner" class="sr-only">Banner</label>
                <input type="text" id="banner" class="form-control form-control-sm commentbox2 text-center" name="banner" value="<%= club.banner %>" placeholder="Banner" autofocus>
                <br>
                <label for="organization" class="text-xs lightgrey"><span class="redcolor">* </span> Unique college key</label>
                <input type="text" id="organization" class="form-control form-control-sm greyback shadow mt-0" name="clubKeys[organization]" value="<%= club.clubKeys.organization %>" placeholder="College name [paste exact string here]">
                <label for="category" class="sr-only" title="Category">Category</label>
                <% if(!club.clubKeys.category){ %>
                  <input list="category" class="form-control form-control-sm select_dark" name="clubKeys[category]" 
                  pattern="Student bodies|TV Shows and Movies|Theatre and Literature|Film and Photography|Sports and Recreational|Automobile and Tech|Dance and Music|Art and Creative|Graphics and Animation|Memes and Video games|Trips and Travel|Food and Beverage|Political and Community service|Personal Care|Academic and Educational|Programming and Development|Bussiness and Management|Bussiness and Management|Placement and Career|Hostelers|Day scholars|Alumni and Staff|Religious and Spiritual|Miscellaneous" value="" placeholder="Club category">
                <% } else{ %>
                  <input list="category" class="form-control form-control-sm select_dark" name="clubKeys[category]" pattern="Student bodies|TV Shows and Movies|Theatre and Literature|Film and Photography|Sports and Recreational|Automobile and Tech|Dance and Music|Art and Creative|Graphics and Animation|Memes and Video games|Trips and Travel|Food and Beverage|Political and Community service|Personal Care|Academic and Educational|Programming and Development|Bussiness and Management|Bussiness and Management|Placement and Career|Hostelers|Day scholars|Alumni and Staff|Religious and Spiritual|Miscellaneous" value="<%= club.clubKeys.category %>" placeholder="Club category">
                <% } %>
                <datalist id="category">
                  <option value="Student bodies">
                  <option value="TV Shows and Movies">
                  <option value="Theatre and Literature">
                  <option value="Film and Photography">
                  <option value="Sports and Recreational">
                  <option value="Automobile and Tech">
                  <option value="Dance and Music">
                  <option value="Art and Creative">
                  <option value="Graphics and Animation">
                  <option value="Memes and Video games">
                  <option value="Trips and Travel">
                  <option value="Food and Beverage">
                  <option value="Political and Community service">
                  <option value="Personal Care">
                  <option value="Academic and Educational">
                  <option value="Programming and Development">
                  <option value="Bussiness and Management">
                  <option value="Placement and Career">
                  <option value="Hostelers">
                  <option value="Day scholars">
                  <option value="Alumni and Staff">
                  <option value="Religious and Spiritual">
                  <option value="Miscellaneous">
                </datalist>
                <label for="weblink" class="sr-only">Weblink</label>
                <input type="text" id="weblink" class="form-control form-control-sm" name="clubKeys[weblink]" value="<%= club.clubKeys.weblink %>" placeholder="Weblink">
                <label for="location" class="sr-only">Location</label>
                <input type="text" id="location" class="form-control form-control-sm" name="clubKeys[location]" value="<%= club.clubKeys.location %>" placeholder="Location">
                <button class="btn btn-sm btn-primary btn-block mt-2" type="submit">Update club profile</button>
              </form>
            </div>
          <% } %>
        </div>
        <% if(currentUser && (rank >= 0 && rank <=4)){ %>
          <div class="mt-2">
            <div class="card mt-0">
              <button type="button" class="btn btn-sm boldtext btncollapse text-left" data-toggle="collapse" data-target="#hot_topics">
                <span class="redcolor"><i class="fas fa-fire"></i></span><span class="boldtext"> HOT Topics</span>
              </button>
              <div id="hot_topics" class="tab-content collapse">
                <div class="card-body3 tab-pane container active" id="thisweek">
                  <% if(topTopicPosts.length != 0){ %>
                    <% for(var i=0;i<topTopicPosts.length;i++){ %>
                    <div class="valign">
                      <div class="valign">
                        <% if(Posts_50_Image && Posts_50_Image[i] == null){ %>
                          <span class="truncate3 mobiletext2 lineheight2 my-1">
                            <span class="badge">[<%= topTopicPosts[i].subpostsCount %>]</span>
                            <span class="linewrap"><a class="darkgrey" href="/clubs/<%= club._id %>/posts/<%= topTopicPosts[i]._id %>"><%= topTopicPosts[i].topic %></a></span>
                          </span>
                        <% } else if(Posts_50_Image && Posts_50_Image[i] != null){ %>
                          <div>
                            <a href="/clubs/<%= club._id %>/posts/<%= topTopicPosts[i]._id %>"><img class="orgdp my-1 mr-2" src="<%= Posts_50_Image[i] || '/images/noClub.png' %>"></a>
                          </div>
                          <div>
                            <span class="truncate3 mobiletext2 lineheight2 my-1">
                              <span class="badge">[<%= topTopicPosts[i].subpostsCount %>]</span>
                              <span class="linewrap"><a class="darkgrey" href="/clubs/<%= club._id %>/posts/<%= topTopicPosts[i]._id %>"><%= topTopicPosts[i].topic %></a></span>
                            </span>
                          </div>
                        <% } %>
                      </div>
                      <div class="mb-auto ml-2 mt-1 badge badge-pill badge-secondary text-md"><%= Number(topTopicPosts[i].upVoteCount)-Number(topTopicPosts[i].downVoteCount) %></div>
                    </div>
                    <% } %>
                  <% } else if(currentUser && (rank >= 0 && rank <=4)){ %>
                    <div class="lightgrey mobiletext2">No discussions created this week :/</div>
                  <% } else if(currentUser && rank == undefined){ %>
                    <div class="lightgrey mobiletext2">You are not a club member :/</div>
                  <% } else if(!currentUser && rank == undefined){ %>
                    <div class="lightgrey mobiletext2">You are not logged in.</div>
                  <% } %>
                </div>
                <div class="card-body3 tab-pane container fade" id="alltime">...</div>
                <hr class="hr-light">
                <div class="card-body1">
                  <ul class="nav justify-content-end">
                    <li class="nav-item">
                      <a class="nav-link nav-topic nothing active text-xs" data-toggle="tab" href="#thisweek">this week</a>
                    </li>
                    <li class="nav-item">
                      <a id="alltime-posts-btn" class="nav-link nav-topic nothing text-xs" data-toggle="tab" href="#alltime">all time</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      </div>
      <div class="col-md-8 px-1 mobilepad mt-2">
        <div class="card tabcard">
          <div class="card-header tabcontainer">
            <ul class="nav nav-tabs card-header-tabs pull-right" id="myTab" role="tablist">
              <li class="nav-item">
                <a class="nav-link boldtext active black" id="activity-tab" data-toggle="tab" href="#activity" role="tab" aria-controls="activity" aria-selected="false">Activity</a>
              </li>
              <li class="nav-item">
                <a class="nav-link boldtext black" id="updates-tab" data-toggle="tab" href="#updates" role="tab" aria-controls="updates" aria-selected="false">Updates</a>
              </li>
              <li class="nav-item">
               <a class="nav-link boldtext black" id="members-tab" data-toggle="tab" href="#members" role="tab" aria-controls="members" aria-selected="true">Members</a>
              </li>
              <% if(0 <= rank && rank <= 1){ %>
                <li class="nav-item">
                  <a class="nav-link boldtext black notification" id="requests-tab" data-toggle="tab" href="#requests" role="tab" aria-controls="requests" aria-selected="true" onclick="document.getElementById('load-more-memberRequests-btn').click();">
                    Requests
                      <% if(memberRequestsLength > 0){ %>
                        <span class="badge badge-white text-xxs"><%= memberRequestsLength %></span>
                      <% } %>
                  </a>
                </li>
              <% } %>
            </ul>
          </div>
            <div class="tab-content" id="myTabContent">
              <!-- Activity Tab -->
              <div class="tab-pane fade show active greyback" id="activity" role="tabpanel" aria-labelledby="activity-tab">
                <% if(rank >= 0 && rank <=4){ %>
                  <div class="card noborder">
                    <form class="card-body2" action="/clubs/<%= club._id %>/posts" method="POST" enctype="multipart/form-data">
                      <% if(rank >= 0 && rank <=3){ %>
                        <label for="topic" class="sr-only">Topic</label>
                        <input id="input_topic" type="text" name="topic" class="form-control topic" placeholder="discussion [topic]" style="border-color: rgba(0,0,0,0.2);">
                      <% } else{ %>
                        <label for="topic" class="sr-only">Topic</label>
                        <input type="text" name="topic" class="form-control topic2" placeholder="discussion [topic]" readonly="readonly" value="" style="border: none;">
                      <% } %>
                      <label for="description" class="sr-only">Description</label>
                      <textarea id="description" class="emoji-input form-control text-sm description" type="text" name="description" placeholder="Describe your post" rows="3" required></textarea>
                      <label for="hyperlink" class="sr-only">Hyperlink</label>
                      <input id="hyperlink" type="text" name="hyperlink" class="form-control text-sm hyperlink" placeholder="Hyperlink">
                      <div class="righttext d-flex my-auto">
                        <span>
                          <div class="emoji-panel">
                            <button class=" emoji-panel chat-input-tool btn btn-sm text-md" style="margin-top: 0.25rem;" type="button" title="Insert hyperlink" onclick="toggle_display('hyperlink')">
                              <i class="fas fa-link"></i>
                            </button>
                          </div>
                        </span>
                        <span>
                          <div class="emoji-panel">
                            <button id="emoji-picker" class=" emoji-panel chat-input-tool btn btn-sm text-lg" type="button" title="Insert emoji">
                              <div id="emoji-box" class="intercom-composer-popover intercom-composer-emoji-popover emoji-right">
                                <% include ../partials/emoji_picker %>
                              </div>
                              <i class="far fa-laugh-wink" style="padding-top: 0.35rem; padding-right: 0.5rem;"></i>
                            </button>
                          </div>
                        </span>
                        <span>
                          <label for="inputImage" class="custom-file-upload" title="Upload image">
                            <i class="fas fa-upload"></i> Image
                          </label>
                          <input type="file" id="inputImage" class="text-sm" name="image" accept="image/*">
                        </span>
                        <span class="righttext d-flex my-auto">
                          <span>
                            <button id="postbutton" class="btn btn-sm btn-success" title="Submit post" onclick="loading_spinner('load-postbutton','description');"><span id="load-postbutton"></span>Post</button>
                          </span>
                          <span>
                            <label for="privacy" class="sr-only" title="Privacy setting">Privacy setting</label>
                            <select id="privacy" name="privacy" class="shortened-select select1 blackcolor" data-toggle="tooltip" title="Privacy setting">
                              <option id="priv_everyone" class="priv_public" value="0" data-descr="Everyone" selected></option>
                              <option class="priv_public" value="1" data-descr="My Friends"></option>
                              <option id="priv_club" value="2" data-descr="This Club"></option>
                              <option value="3" data-descr="Friends in Club"></option>
                              <option value="4" data-descr="Only Me"></option>
                            </select>
                          </span>
                        </span>
                      </div>
                    </form>
                  </div>
                <% } %>
                <div id="delegated-posts">
                  <div id="server-posts">
                    <% //include ../partials/posts_club %>
                  </div>
                  <div id="client-posts"></div>
                  <div class="text-center">
                    <button id="load-more-btn" class="btn btn-light btn-sm btn-load mt-2" type="button" value="<%= //foundPostIds %>">
                      <span id="load-more-span"></span>Load
                    </button>
                  </div>
                </div>
              </div>
              <!-- Updates Tab -->
              <div class="tab-pane fade cardpad greyback nothing" id="updates" role="tabpanel" aria-labelledby="updates-tab">
                <% if(0 <= rank && rank <= 1){ %>
                  <div class="updates-card updates-input">
                    <form action="/clubs/<%= club._id %>?_method=PUT" method="POST">
                      <div class="row no-gutters">
                        <div class="col-md-3 col-4">
                          <div class="input-group mt-1 date" id="datetimepicker4" data-target-input="nearest">
                            <div class="input-group-prepend" data-target="#datetimepicker4" data-toggle="datetimepicker">
                              <div class="input-group-text"><i class="far fa-calendar-alt"></i></div>
                            </div>
                            <input name="newsDate" type="text" class="form-control datetimepicker-input commentbox4 text-sm mobiletext3" data-target="#datetimepicker4" placeholder="mm/dd/yyyy (event date)">
                          </div>
                        </div>
                        <div class="col-md-9 col-8 pl-2">
                          <div class="input-group mt-1">
                            <input type="text" name="newsUpdate" class="form-control commentbox3 text-sm" placeholder="Write an update">
                            <div class="input-group-append">
                              <button class="btn btn-secondary btnxxs text-xs" type="submit">Push</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                <% } else if(rank == 2){ %>
                  <div class="updates-card updates-input">
                    <form action="/clubs/<%= club._id %>?_method=PUT" method="POST">
                      <div>
                        <div class="input-group mt-1">
                          <input type="text" name="newsUpdate" class="form-control commentbox3 text-sm" placeholder="Write an update">
                          <div class="input-group-append">
                            <button class="btn btn-secondary btnxxs text-xs" type="submit">Push</button>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                <% } %>
                <% if(club.updates && club.updates != ''){ %>
                  <div class="updates-card">
                    <% for(i=club.updates.length-1;i>=0;i--){ %>
                      <div class="d-flex flex-row">
                        <% if(club.updates[i].eventDate){ %>
                          <div class="text-md mx-2 my-1 lineheight">
                            <time datetime="<%= moment(club.updates[i].eventDate).format('LL') %>" class="calendar">
                              <em><%= moment(club.updates[i].eventDate).format('dddd') %></em>
                              <strong><%= moment(club.updates[i].eventDate).format('MMM') %></strong>
                              <span><%= moment(club.updates[i].eventDate).format('D') %></span>
                            </time>
                          </div>
                        <% } else{ %>
                          <div class="eventD text-md mx-2 my-1 lineheight"></div>
                        <% } %>
                        <div class="mx-2 pb-3 my-auto news mobiletext">
                          <%= club.updates[i].news %>
                          <span class="lightgrey text-xxs boldtext">[<em><%= moment(club.updates[i].pushedAt).calendar() %></em>]</span>
                          <span class="lightgrey text-xxs boldtext nothing">[by: <em><%= club.updates[i].pusherName %></em>]</span>
                        </div>
                        <div class="d-flex flex-row ml-auto mb-auto">
                          <% if(0 <= rank && rank <= 1){ %>
                            <span class="dropdown ml-auto mb-auto">
                              <button class="btn btn-sm dropdown-toggle editprofile" type="button" data-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                              <ul class="dropdown-menu dropdown-menu-right dropbox">
                                <div class="container drop-shadow1">
                                  <li>
                                    <button class="dropitems link-button red text-sm" href="#delUpdateModal<%= club.updates[i]._id %>" data-toggle="modal">Delete update</button>
                                  </li>
                                </div>
                              </ul>
                            </span>
                            <!-- Modal HTML -->
                            <div id="delUpdateModal<%= club.updates[i]._id %>" class="fixed-padding modal fade">
                              <div class="modal-dialog modal-confirm">
                                <div class="modal-content">
                                  <div class="d-flex">
                                    <span class="icon-box">
                                      <i class="fas fa-exclamation-triangle text-xxxl"></i>
                                    </span>              
                                    <span class="my-auto"><h5 class="modal-title">Are you sure?</h5></span>
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                  </div>
                                  <div>
                                    <p>Do you really want to delete this update? This cannot be undone.</p>
                                  </div>
                                  <div class="my-2">
                                    <button type="button" class="btn btn-secondary btn-sm mr-1" data-dismiss="modal">Cancel</button>
                                    <form class="delete-form inline text-sm" action="/clubs/<%= club._id %>?_method=PUT" method="POST">
                                      <button class="btn btn-danger btn-sm ml-1" name="delUpdate" value="<%= club.updates[i]._id %>" type="submit">Delete</button>
                                    </form>
                                  </div>
                                </div>
                              </div>
                            </div>
                          <% } %>
                        </div>
                      </div>
                    <% } %>
                  </div>
                <% } else if(0 <= rank && rank <= 4){ %>
                  <div class="updates-card">
                    <div class="text-center lightgrey text-sm pt-1">No updates yet.</div>
                  </div>
                <% } else{ %>
                  <div class="updates-card">
                    <div class="text-center lightgrey text-sm pt-1">You are not a club member :/</div>
                  </div>
                <% } %>
              </div>
              <!-- Members Tab -->
              <div class="tab-pane fade cardpad" id="members" role="tabpanel" aria-labelledby="members-tab">
                <div class="greyback valign" style="height: 23px;">
                  <div class="d-flex flex-row">
                    <span class="lightgrey text-sm my-auto ml-2"><%= club.membersCount %> members</span>
                  </div>
                  <div class="d-flex">
                    <div>
                      <button onclick="toggle_display('searchMember_form'); toggle_display('inv_requests');" class="btn btnxs chat-input-tool my-auto" title="Search members"><i class="fas fa-search"></i></button>
                    </div>
                    <div id="searchMember_form">
                      <div class="input-group input-group-sm">
                        <input id="search-members-input" type="text" name="name" class="form-control search shadow ml-1" placeholder="Search member" autofocus required style="height: 26px; width: 185px; border: none;">
                        <div class="input-group-append">
                          <button id="search-members-btn" class="btn btn-secondary search py-0 px-1" type="submit" style="height: 26px;">
                            <span id="search-members-span"></span>Go
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="server-members">
                  <% include ../partials/club_members %>
                </div>
                <div id="client-members"></div>
                <% if(0 <= rank && rank <= 4){ %>
                  <div class="text-center">
                    <button id="load-more-members-btn" class="btn btn-light btnxxs text-sm mt-2" type="button" value="1,11">
                      <span id="load-more-members-span"></span>Load
                    </button>
                  </div>
                <% } %>
              </div>
              <% if(0 <= rank && rank <= 1){ %>
                <!-- Member Requests Tab -->
                <div class="tab-pane fade cardpad" id="requests" role="tabpanel" aria-labelledby="requests-tab">
                  <div class="greyback" style="height: 23px;">
                    <div class="d-flex flex-row">
                      <span class="lightgrey text-sm my-auto ml-2"><%= memberRequestsLength %> Member Reqs.</span>
                    </div>
                  </div>
                  <div id="client-memberRequests"></div>
                  <div class="text-center">
                    <button id="load-more-memberRequests-btn" class="btn btn-light btnxxs text-sm mt-2" type="button" value="0,10">
                      <span id="load-more-memberRequests-span"></span>Load
                    </button>
                  </div>
                </div>
              <% } %>
            </div>
        </div>
      </div>
    </div>
  </div>
  <% if(currentUser && 0 <= rank && rank <=4){ %>
    <div id="pin-chatbox" class="col-md-4 col-lg-3 px-2 pb-2" value="<%= currentUser.firstName %>">
      <div id="club-convoId" class="club-convoId" value="<%= conversationId %>,<%= convClubId %>,<%= currentUser._id %>">
        <% include ../partials/clubchat %>
      </div>
    </div>
  <% } else if(currentUser && (!rank || 0 >= rank && rank >=4)){ %>
    <div class="col-md-4 col-lg-3 px-2 pb-2">
      <div class="m-0">
        <div class="lightgrey lineheight text-sm text-center">
          <i class="fas fa-exclamation redcolor"></i> You are not a member of this club. Ask for an invite to participate in exclusive content & discussions ;)
        </div>
        <div class="card-body hr1 mx-3">
          <div class="lightgrey lineheight text-sm text-center">
            <% if(!sentMemberReq){ %>
              <button id="memberReq-btn" class="btn btn-white btn-primary btn-ask boldtext" onclick="toggle_display('memberReq-div')">Ask</button>
            <% } else{ %>
              <form action="/clubs/<%= club._id %>/member_requests?_method=PUT" method="POST">
                <button id="cancelReq-btn" class="btn btnxs text-sm btn-dark" name="cancelReq" value="<%= club._id %>">Cancel Request</button>
              </form>
            <% } %>
          </div>
        </div>
        <div id="memberReq-div" class="mx-3 my-2 mt-3">
          <div class="card-body mail-wrap mx-auto">
            <div class="memberRequest_form whiteback" style="border-radius: 0.75rem;">
              <form action="/clubs/<%= club._id %>/member_requests?_method=PUT" method="POST">
                <div class="form-signin">
                  <label for="message" class="sr-only">Club name</label>
                    <textarea id="message" class="form-control form-control-sm" type="text" name="message" placeholder="Request message" rows="3" required></textarea>
                  <button class="btn btn-sm btn-success btnshadow d-flex ml-auto" title="member request" name="memberReq" value="<%= club._id %>">Send</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% } %>
</div>

<script type='text/javascript'>
  var club = <%- JSON.stringify(club) %>;
</script>
<% include ../partials/footer %>
<script src="/js/mapbox.js"></script>


<% function tags_split(arr){ %>
  <% var len = arr.length; var i=0; for(i;i<len;i++){ %>
  <% if(i==0 && i==len-1){ %>
    <%= arr[i] %>
    <% }else if(i==0){ %>
    <%= arr[i] %><%= ',' %>
    <% }else if(i>0 && i<len-1){ %>
    <%= ' ' %><%= arr[i] %><%= ',' %>
    <% }else if(i=len-1){ %>
    <%= ' ' %><%= arr[i] %>
  <% }} %>
<% } %>

<%
  function rankTitle(rank){
    if(rank == 0){return 'Owner';}
    else if(rank == 1){return 'Admin.';}
    else if(rank == 2){return 'Moderator';}
    else if(rank == 3){return 'Sr. member';}
    else if(rank == 4){return 'Jr. member';}
  }

  function privacyText(privacy){
    if(privacy == 0){return 'Public';}
    else if(privacy == 1){return 'Friends';}
    else if(privacy == 2){return 'Club';}
    else if(privacy == 3){return 'Club(friends)';}
    else if(privacy == 4){return 'Private';}
  }
%>