<% include ../partials/header %>
<style>
  @media screen and (max-width: 767px){
    #mob_profilePic_toppad{
      margin-top: 1.5rem;
    }
  }
</style>
<script type='text/javascript'>
  var adminClubs = <%- JSON.stringify(adminClubs) %>;
  var invitedUser = <%- JSON.stringify(user._id) %>;
  var clubInvites = <%- JSON.stringify(clubInvites) %>;
</script>

<div class="row no-gutters content-toppad">
  <div class="col-lg-9 order-md-first order-last">
    <div class="row no-gutters">
      <div class="col-md-12">
        <% if(currentUser && match){ %>
          <div class="d-flex flex-row">
        <% } else{ %>
          <div id="mob_profilePic_toppad" class="d-flex flex-row">
        <% } %>
          <div id="profilePic-frame-div-desktop">
            <% if(currentUser && match && user.profilePicId){ %>
              <div>
                <button id="delete_profilePic-desktop" class="btn btn-danger btnxs text-xxs btn-shadow rounded-circle" type="button"
                title="Delete profile pic" href="#deleteProfilePicModal" data-toggle="modal">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            <% } %>
            <div class="card indexcard ml-1 p-1 coverback2 profilePic-frame lcov">
              <div class="container rounded-circle" style="overflow: hidden;">
                <% if(user.profilePicId){ %>
                  <img class="profilePic cover image" src="<%= cdn_prefix+user.profilePicId %>">
                <% } else{ %>
                  <% if(!user.userKeys.sex){ %>
                    <img class="profilePic cover image" src="<%= '/images/noUser.png' %>">
                  <% } else if(user.userKeys.sex == 'Male'){ %>
                    <img class="profilePic cover image" src="<%= '/images/noUserMale.png' %>">
                  <% } else if(user.userKeys.sex == 'Female'){ %>
                    <img class="profilePic cover image" src="<%= '/images/noUserFemale.png' %>">
                  <% } %>
                <% } %>
                <% if(currentUser && match){ %>
                  <form action="/users/<%= user._id %>?_method=PUT&_csrf=<%= csrfToken %>" method="POST" enctype="multipart/form-data">
                    <label for="inputprofilePic" class="overlay pt-0 text-mob-sm" style="outline: 4px solid rgba(0,0,0,0.5); padding-bottom: 2.5rem;">
                      <i class="fas fa-upload mr-2"></i>profile pic
                    </label>
                    <input type="file" id="inputprofilePic" class="text-sm" name="profilePic" accept="image/*" required>
                    <button id="inputprofilePicSubmitBtn" class="btn btn-success overlay2 border-0" onclick="loading_spinner('load-updateprofilePic','');"><span id="load-updateprofilePic"></span>Submit</button>
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  </form>
                <% } %>
              </div>
            </div>
          </div>
          <div class="d-flex flex-column w-100 mobileNoneFlex">
            <div class="my-auto">
              <div id="username_profile_div">
                <div class="valign">
                  <div>
                    <% if(user.isVerified){ %>
                      <h5 class="profilename text-left"><%= user.fullName %></h5>
                    <% } else{ %>
                      <h5 class="profilename text-left"><sub class="redcolor" title="Not Verified" style="font-size: 2rem; cursor: default;">*</sub><%= user.fullName %></h5>
                    <% } %>
                  </div>
                  <% if(currentUser && !match){ %>
                    <div class="px-2 pb-1">
                      <% if(currentUser && !match){ %>
                        <% if(wasActiveToday && wasActiveMinuteago){ %>
                          <svg id="isUserInRoom" height="12" width="12">
                            <circle cx="6" cy="6" r="4" stroke="#60b769" stroke-width="1" fill="#9feca6"/>
                          </svg>
                        <% } else if(wasActiveToday && !wasActiveMinuteago){ %>
                          <svg id="isUserInRoom" height="12" width="12">
                            <path d="M7.2 1.8A4.5 4.5 90 1010.8 7.2C6.5835 8.9946 4.1679 4.3218 7.2 1.8z" stroke="#f9af4a" stroke-width="1" fill="#ffdfaf"/>
                          </svg>
                        <% } else{ %>
                          <svg id="isUserInRoom" height="12" width="12">
                            <circle cx="6" cy="6" r="4" stroke="rgba(150,150,150,0.5)" stroke-width="1" fill="transparent"/>
                          </svg>
                        <% } %>
                      <% } %>
                    </div>
                  <% } %>
                </div>
                <div class="profilename text-sm text-mob-xs boldtext lineheight w-80"><%= user.note %></div>
              </div>
            </div>
            <div class="profilename text-md d-flex flex-row mobileNoneFlex">
              <div>
                <span class="boldtext"><%= user.creationCount.posts %></span>
                <% if(user.creationCount.posts == 1){ %>
                  <span>post</span>
                <% } else{ %>
                  <span>posts</span>
                <% } %>
              </div>
              <div class="ml-4">
                <span class="boldtext"><%= user.creationCount.questions %></span>
                <% if(user.creationCount.questions == 1){ %>
                  <span>question</span>
                <% } else{ %>
                  <span>questions</span>
                <% } %>
              </div>
              <div class="ml-4">
                <span class="boldtext"><%= user.creationCount.blogs %></span>
                <% if(user.creationCount.blogs == 1){ %>
                  <span>blog</span>
                <% } else{ %>
                  <span>blogs</span>
                <% } %>
              </div>
            </div>
          </div>
          <div class="profilename text-md d-flex flex-row my-auto desktopNoneFlex">
            <div class="d-flex flex-column">
              <div class="boldtext text-center"><%= user.creationCount.posts %></div>
              <% if(user.creationCount.posts == 1){ %>
                <div class="text-mob-sm">Post</div>
              <% } else{ %>
                <div class="text-mob-sm">Posts</div>
              <% } %>
            </div>
            <div class="d-flex flex-column ml-4">
              <div class="boldtext text-center"><%= user.creationCount.questions %></div>
              <% if(user.creationCount.questions == 1){ %>
                <div class="text-mob-sm">Question</div>
              <% } else{ %>
                <div class="text-mob-sm">Questions</div>
              <% } %>
            </div>
            <div class="d-flex flex-column ml-4">
              <div class="boldtext text-center"><%= user.creationCount.blogs %></div>
              <% if(user.creationCount.blogs == 1){ %>
                <div class="text-mob-sm">Blog</div>
              <% } else{ %>
                <div class="text-mob-sm">Blogs</div>
              <% } %>
            </div>
          </div>
        </div>
        <% if(currentUser && match){ %>
          <div class="desktopNoneFlex mt-3" style="margin-bottom: 11.125rem;">
        <% } else{ %>
          <div class="desktopNoneFlex mt-3" style="margin-bottom: 13.375rem;">
        <% } %>
          <div id="username_profile_div" class="w-100">
            <div class="valign">
              <div>
                <% if(user.isVerified){ %>
                  <h5 class="profilename text-left"><%= user.fullName %></h5>
                <% } else{ %>
                  <h5 class="profilename text-left"><sub class="redcolor" title="Not Verified" style="font-size: 2rem; cursor: default;">*</sub><%= user.fullName %></h5>
                <% } %>
              </div>
              <% if(currentUser && !match){ %>
                <div class="px-2 pb-1">
                  <% if(currentUser && !match){ %>
                    <% if(wasActiveToday && wasActiveMinuteago){ %>
                      <svg id="isUserInRoom" height="12" width="12">
                        <circle cx="6" cy="6" r="4" stroke="#60b769" stroke-width="1" fill="#9feca6"/>
                      </svg>
                    <% } else if(wasActiveToday && !wasActiveMinuteago){ %>
                      <svg id="isUserInRoom" height="12" width="12">
                        <path d="M7.2 1.8A4.5 4.5 90 1010.8 7.2C6.5835 8.9946 4.1679 4.3218 7.2 1.8z" stroke="#f9af4a" stroke-width="1" fill="#ffdfaf"/>
                      </svg>
                    <% } else{ %>
                      <svg id="isUserInRoom" height="12" width="12">
                        <circle cx="6" cy="6" r="4" stroke="rgba(150,150,150,0.5)" stroke-width="1" fill="transparent"/>
                      </svg>
                    <% } %>
                  <% } %>
                </div>
              <% } %>
            </div>
            <% if(user.note){ %>
              <div class="profilename text-sm text-mob-xs boldtext lineheight w-80" style="padding-top: 0 !important;"><%= user.note %></div>
            <% } else{ %>
              <div class="profilename text-sm text-mob-xs boldtext lineheight w-80 invisible" style="padding-top: 0 !important;">short note</div>
            <% } %>
          </div>
        </div>
        <!-- Modal HTML -->
        <div id="deleteProfilePicModal" class="fixed-padding modal fade">
          <div class="modal-dialog modal-confirm">
            <div class="modal-content">
              <div class="d-flex grey">
                <span class="icon-box">
                  <i class="fas fa-exclamation text-xxxl"></i>
                </span>              
                <span class="my-auto"><h5 class="modal-title">Are you sure?</h5></span>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
              </div>
              <div>
                <p>Do you want to delete your profile pic?</p>
              </div>
              <div class="my-2">
                <button type="button" class="btn btn-secondary btn-sm mr-1" data-dismiss="modal">Cancel</button>
                <form action="/users/<%= user._id %>?_method=PUT&_csrf=<%= csrfToken %>" method="POST" class="delete-form inline">
                  <button name="deleteProfilePic" type="submit" value="true" class="btn btn-danger btn-sm ml-1">Delete</button>
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4 px-1 mobilepad desktop-mt-2 keyspad keys-container">
        <div class="card border-light"> 
          <div class="card-body">
            <div class="dropctn">
              <h5 id="keys-h5">Keys</h5>      
              <div class="dropdown">
                <% if(currentUser){ %>
                  <button class="btn btn-sm dropdown-toggle mb-1" type="button" data-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                <% } %>
                <ul class="dropdown-menu dropdown-menu-right dropbox">
                  <div class="container drop-shadow1">
                    <% if(currentUser && match){ %>
                      <li onclick="toggle_display('toggle_profile_form');"><a class="dropitems text-sm" href="#">Edit user Keys</a></li>
                    <% } %>
                    <li><a class="dropitems text-sm">Help ?</a></li>
                  </div>
                </ul>
              </div>
            </div>
            <hr class="hr-light mobileNone">
            <div class="d-flex flex-column text-sm">
              <div class="info1">College: <div class="info30 boldtext"><a href="/colleges/<%= user.userKeys.college %>"><%= user.userKeys.college %></a></div></div>
              <div class="info1">Batch: <div class="info30"><a href="/all_students/colleges/<%= user.userKeys.college %>?batch=<%= user.userKeys.batch %>"><%= user.userKeys.batch %></a></div></div>
              <div class="info1">Branch: <div class="info30"><a href="/all_students/colleges/<%= user.userKeys.college %>?branch=<%= user.userKeys.branch %>"><%= user.userKeys.branch %></a></div></div>
            </div>
          </div>
          <% if(currentUser && match){ %>
            <div id="toggle_profile_form">
              <hr>
              <form class="form-signin" action="/users/<%= user._id %>?_method=PUT" method="POST">
                <label for="note" class="sr-only">Note</label>
                <input type="text" id="note" class="form-control form-control-sm commentbox2 text-center" name="note" value="<%= user.note %>" placeholder="Short note" autofocus>
                <br>
                <label for="college" class="sr-only text-xs lightgrey"><span class="redcolor">* </span> Unique college key</label>
                <% if(!user.userKeys.college){ %>
                  <input list="college" class="form-control form-control-sm select_dark" name="userKeys[college]" 
                  pattern="IIT Mandi" value="" placeholder="Your College">
                <% } else{ %>
                  <input list="college" class="form-control form-control-sm select_dark" name="userKeys[college]" pattern="IIT Mandi" value="<%= user.userKeys.college %>" placeholder="Your College">
                <% } %>
                <datalist id="college">
                  <option value="IIT Mandi">
                </datalist>
                <label for="batch" class="sr-only">Batch</label>
                <% if(!user.userKeys.batch){ %>
                  <input list="batch" class="form-control form-control-sm select_dark" name="userKeys[batch]" 
                  pattern="2015|2016|2017|2018|2019|2020|2021" value="" placeholder="First year">
                <% } else{ %>
                  <input list="batch" class="form-control form-control-sm select_dark" name="userKeys[batch]" pattern="2015|2016|2017|2018|2019|2020|2021" value="<%= user.userKeys.batch %>" placeholder="Your batch (first year)">
                <% } %>
                <datalist id="batch">
                  <option value="2015">
                  <option value="2016">
                  <option value="2017">
                  <option value="2018">
                  <option value="2019">
                  <option value="2020">
                  <option value="2021">
                </datalist>
                <label for="branch" class="sr-only">Branch</label>
                <% if(!user.userKeys.branch){ %>
                  <input list="branch" class="form-control form-control-sm select_dark" name="userKeys[branch]"  title="Select from the branches avaliable in your college"
                  pattern="<% arrayToStingWithPipe(college.branches); %>" value="" placeholder="Branch">
                <% } else{ %>
                  <input list="branch" class="form-control form-control-sm select_dark" name="userKeys[branch]" title="Select from the branches avaliable in your college"
                  pattern="<% arrayToStingWithPipe(college.branches); %>" value="<%= user.userKeys.branch %>" placeholder="Branch">
                <% } %>
                <datalist id="branch">
                  <% arrayToDatalistOptions(college.branches); %>
                </datalist>
                <button class="btn btn-sm btn-primary btn-block mt-2" type="submit">Update user profile</button>
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
              </form>
            </div>
          <% } %>
        </div>
      </div>
      <div class="col-md-8 px-1 mobilepad desktop-mt-2">
        <div class="card tabcard">
          <div class="card-header tabcontainer">
            <ul class="nav nav-tabs card-header-tabs pull-right" id="myTab" role="tablist">
              <li class="nav-item">
                <% if(currentUser && !match){ %>
                  <a class="nav-link boldtext black active" id="activity-tab" data-toggle="tab" href="#activity" role="tab" aria-controls="activity" aria-selected="true">Activity</a>
                <% } else{ %>
                  <a class="nav-link boldtext black" id="activity-tab" data-toggle="tab" href="#activity" role="tab" aria-controls="activity" aria-selected="true">Activity</a>
                <% } %>
              </li>
              <li class="nav-item">
                <a class="nav-link boldtext black" id="clubs-tab" data-toggle="tab" href="#clubs" role="tab" aria-controls="clubs" aria-selected="false">Clubs</a>
              </li>
              <li class="nav-item">
                <% if(currentUser && match){ %>
                  <a class="nav-link boldtext black active" id="info-tab" data-toggle="tab" href="#info" role="tab" aria-controls="info" aria-selected="false">Info</a>
                <% } else{ %>
                  <a class="nav-link boldtext black" id="info-tab" data-toggle="tab" href="#info" role="tab" aria-controls="info" aria-selected="false">Info</a>
                <% } %>
              </li>
              <% if(currentUser && match){ %>
                <li class="nav-item">
                 <a class="nav-link boldtext black" id="saved-tab" data-toggle="tab" href="#saved" role="tab" aria-controls="saved" aria-selected="true" onclick="document.getElementById('load-more-heart-btn').click();">Saved</a>
                </li>
              <% } else if(currentUser && !match){ %>
                <li class="nav-item">
                 <a class="nav-link boldtext black" id="chats-tab" data-toggle="tab" href="#chats" role="tab" aria-controls="chats" aria-selected="true">Chat</a>
                </li>
              <% } %>
            </ul>
          </div>
          <div class="tab-content" id="myTabContent">
            <!-- Activity Tab -->
            <% if(currentUser && !match){ %>
              <div class="tab-pane fade greyback show active" id="activity" role="tabpanel" aria-labelledby="activity-tab">
            <% } else{ %>
              <div class="tab-pane fade greyback" id="activity" role="tabpanel" aria-labelledby="activity-tab">
            <% } %>
              <div id="delegated-posts">
                <div id="server-posts"></div>
                <div id="client-posts" class="topnotch-left topnotch-right d-none"></div>
                <div class="text-center">
                  <button id="load-more-btn" class="btn btn-light btn-sm btn-load mt-2" type="button" value="<%= //foundPostIds %>">
                    <span id="load-more-span"></span>Load
                  </button>
                </div>
              </div>
            </div>
            <!-- Clubs Tab -->
            <div class="tab-pane fade cardpad border-light-lr" id="clubs" role="tabpanel" aria-labelledby="clubs-tab">
              <div id="userclubs_strip" class="greyback rounded valign my-auto">
                <div class="d-flex flex-row">
                  <span class="lightgrey text-sm mx-2 my-auto"><%= clubCount %> <%= clubCount == 1 ? 'club': 'clubs' %></span>
                </div>
                <div class="d-flex flex-row">
                  <% if(currentUser && !match && adminClubs.length!=0){ %>
                    <div>
                      <form action="/requests?_method=PUT" method="POST" class="form-inline">
                        <div id="clubInvite-select" class="clubInvite-select"></div>
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      </form>
                    </div>
                  <% } %>
                  <% if(currentUser && !match && user.clubInvites.length!=0){ %>
                    <div>
                      <form action="/requests?_method=PUT" method="POST" class="form-inline">
                        <div id="inviteCancel-select" class="inviteCancel-select"></div>
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      </form>
                    </div>
                  <% } %>
                  <% if(currentUser && match){ %>
                    <div class="d-flex">
                      <button id="new-club" class="btn btnxs text-xs btn-white my-auto" style="height: 26px;" href="#startNewClub" data-toggle="modal"><i class="fas fa-plus mr-2 lightgrey"></i>New</button>
                    </div>
                  <% } %>
                </div>
              </div>
              <!-- Modal HTML -->
              <div id="startNewClub" class="fixed-padding modal fade">
                <div class="modal-dialog modal-dialog-centered modal-confirm">
                  <div class="modal-content">
                    <div class="d-flex grey">
                      <span>
                        <img id="new_club_img" class="icon-box" src="https://res.cloudinary.com/dubirhea4/image/upload/v1650015521/icons/new_club.png" title="Designed by [Freepik] from @flaticon">
                      </span>              
                      <span class="my-auto"><h5 class="modal-title ml-2">Start new club</h5></span>
                      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    </div>
                    <form class="my-2" action="/users/<%= user._id %>/clubs/new?_csrf=<%= csrfToken %>" method="POST" enctype="multipart/form-data">
                      <div class="form-signin">
                        <label for="name" class="sr-only">Club name</label>
                        <input id="name" class="form-control form-control-sm shadow commentbox2" type="text" name="name" placeholder="Club name" required>
                        <label for="inputclubAvatar" class="custom-file-upload btn btn-rounded shadow-none border-0 w-100 mt-2" title="Upload club avatar">
                          <i class="fas fa-upload mr-2"></i>Club avatar
                        </label>
                        <input type="file" id="inputclubAvatar" class="text-sm" name="avatar" accept="image/*" required="">
                        <br>
                        <br>
                        <br>
                        <button class="btn btn-sm btn-success btn-block" title="Start new club" onclick="loading_spinner('load-createclub','name');"><span id="load-createclub"></span>Submit</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              <% if(currentUser && clubs.length!=0){ %>
                <div id="server-clubs">
                  <% include ../partials/user_clubs %>
                </div>
                <div id="client-clubs"></div>
                <% if(clubCount > 10){ %>
                  <div class="text-center">
                    <button id="load-more-clubs-btn" class="btn btn-light btnxxs text-sm mt-2" type="button" value="10,20">
                      <span id="load-more-clubs-span"></span>Load More
                    </button>
                  </div>
                <% } %>
              <% } %>
            </div>
            <!-- **********************Info START************************ -->
            <% if(currentUser && match){ %>
              <div class="tab-pane fade cardpad show active border-light-lr" id="info" role="tabpanel" aria-labelledby="info-tab">
            <% } else{ %>
              <div class="tab-pane fade cardpad" id="info" role="tabpanel" aria-labelledby="info-tab">
            <% } %>
              <div class="d-flex flex-row">
                <span class="ml-auto">
                  <button class="btn btn-white btnxxs text-sm invisible" type="button">
                    <% if(currentUser && match){ %>
                      <span id="my_profile_page">Me</span>
                    <% } else{ %>
                      <span>Not Me</span>
                    <% } %>
                  </button>
                </span>
              </div>
              <div class="d-flex flex-column px-1 mobilepad mt-2">
                <div class="dropctn">
                  <strong class="info-size">Bio:</strong>
                </div>
                <% if(currentUser && (match || user.bio.aboutme)){ %>
                  <div class="info1">
                    About me: 
                    <div class="info30">
                      <% if(currentUser && match){ %>
                        <button onclick="toggle_display('aboutme_form_div');" class="btn btn-sm dropdown-toggle floatright m-0 p-0 d-flex pt-1 pl-1 mb-auto"><i class="fas fa-edit"></i></button>
                      <% } %>
                      <span class="clubchat-msg-div"><%= user.bio.aboutme %></span>
                      <br>
                      <div id="aboutme_form_div" class="greyback">
                        <form class="form-inline d-flex justify-content-between mt-2 px-2" action="/users/<%= user._id %>?_method=PUT" method="POST">
                          <div id="aboutme_form" class="w-100">
                            <label for="aboutme" class="sr-only">About me</label>
                            <input type="hidden" id="aboutme" name="aboutme" value="#">
                            <textarea type="text" id="aboutmetext" class="form-control w-100" name="aboutmetext" placeholder="Tell about yourself" rows="5"><%= user.bio.aboutme %></textarea>
                          </div>
                          <div class="d-flex flex-row-reverse w-100 mb-1">
                            <button class="btn btn-sm btnxs btn-primary ml-2" type="submit">Update</button>
                          </div>
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        </form>
                      </div>
                      <br>
                    </div>
                  </div>
                <% } %>
                <% if(currentUser && (match || (user.bio.instagram || user.bio.facebook || user.bio.linkedin || user.bio.twitter || user.bio.discord
                || user.bio.github || user.bio.spotify || user.bio.youtube || user.bio.custom1 || user.bio.custom2))){ %>
                  <div class="info1">
                    Find me on: 
                    <div class="info30">
                      <% if(currentUser && match){ %>
                        <button onclick="toggle_display('findmeon_form_div');" class="btn btn-sm dropdown-toggle floatright m-0 p-0 d-flex pt-1 pl-1 mb-auto"><i class="fas fa-edit"></i></button>
                      <% } %>
                      <% if(user.bio.instagram){ %>
                        <a href="<%= decodeURI(user.bio.instagram) %>" target="_blank" rel="noopener" class="text-xxxl lightgrey mr-2"><i class="fab fa-instagram"></i></a>
                      <% } %>
                      <% if(user.bio.facebook){ %>
                        <a href="<%= decodeURI(user.bio.facebook) %>" target="_blank" rel="noopener" class="text-xxxl lightgrey mr-2"><i class="fab fa-facebook"></i></a>
                      <% } %>
                      <% if(user.bio.linkedin){ %>
                        <a href="<%= decodeURI(user.bio.linkedin) %>" target="_blank" rel="noopener" class="text-xxxl lightgrey mr-2"><i class="fab fa-linkedin"></i></a>
                      <% } %>
                      <% if(user.bio.twitter){ %>
                        <a href="<%= decodeURI(user.bio.twitter) %>" target="_blank" rel="noopener" class="text-xxxl lightgrey mr-2"><i class="fab fa-twitter"></i></a>
                      <% } %>
                      <% if(user.bio.discord){ %>
                        <a href="<%= decodeURI(user.bio.discord) %>" target="_blank" rel="noopener" class="text-xxxl lightgrey mr-2"><i class="fab fa-discord"></i></a>
                      <% } %>
                      <% if(user.bio.github){ %>
                        <a href="<%= decodeURI(user.bio.github) %>" target="_blank" rel="noopener" class="text-xxxl lightgrey mr-2"><i class="fab fa-github"></i></a>
                      <% } %>
                      <% if(user.bio.spotify){ %>
                        <a href="<%= decodeURI(user.bio.spotify) %>" target="_blank" rel="noopener" class="text-xxxl lightgrey mr-2"><i class="fab fa-spotify"></i></a>
                      <% } %>
                      <% if(user.bio.youtube){ %>
                        <a href="<%= decodeURI(user.bio.youtube) %>" target="_blank" rel="noopener" class="text-xxxl lightgrey mr-2"><i class="fab fa-youtube"></i></a>
                      <% } %>
                      <% if(user.bio.custom1){ %>
                        <a href="<%= decodeURI(user.bio.custom1) %>" target="_blank" rel="noopener" class="text-xxxl lightgrey mr-2"><i class="fas fa-link"></i></a>
                      <% } %>
                      <% if(user.bio.custom2){ %>
                        <a href="<%= decodeURI(user.bio.custom2) %>" target="_blank" rel="noopener" class="text-xxxl lightgrey mr-2"><i class="fas fa-link"></i></a>
                      <% } %>
                      <br>
                      <div id="findmeon_form_div" class="greyback">
                        <form class="form-inline d-flex justify-content-between mt-2 px-2" action="/users/<%= user._id %>?_method=PUT" method="POST">
                          <div id="findmeon_form" class="d-flex flex-column w-100">
                            <div class="d-flex flex-row">
                              <div class="text-xxxxl lightgrey my-auto mr-2"><i class="fab fa-instagram" style="width: 36px;"></i></div>
                              <div class="w-100"><input type="text" class="form-control form-control-sm" name="instagram" placeholder="Instagram profile" style="width: inherit;" value="<%= decodeURI(user.bio.instagram) %>"></div>
                            </div>
                            <div class="d-flex flex-row">
                              <div class="text-xxxxl lightgrey my-auto mr-2"><i class="fab fa-facebook" style="width: 36px;"></i></div>
                              <div class="w-100"><input type="text" class="form-control form-control-sm" name="facebook" placeholder="Facebook profile" style="width: inherit;" value="<%= decodeURI(user.bio.facebook) %>"></div>
                            </div>
                            <div class="d-flex flex-row">
                              <div class="text-xxxxl lightgrey my-auto mr-2"><i class="fab fa-linkedin" style="width: 36px;"></i></div>
                              <div class="w-100"><input type="text" class="form-control form-control-sm" name="linkedin" placeholder="LinkedIn profile" style="width: inherit;" value="<%= decodeURI(user.bio.linkedin) %>"></div>
                            </div>
                            <div class="d-flex flex-row">
                              <div class="text-xxxxl lightgrey my-auto mr-2"><i class="fab fa-twitter" style="width: 36px;"></i></div>
                              <div class="w-100"><input type="text" class="form-control form-control-sm" name="twitter" placeholder="Twitter profile" style="width: inherit;" value="<%= decodeURI(user.bio.twitter) %>"></div>
                            </div>
                            <div class="d-flex flex-row">
                              <div class="text-xxxxl lightgrey my-auto mr-2"><i class="fab fa-discord" style="width: 36px;"></i></div>
                              <div class="w-100"><input type="text" class="form-control form-control-sm" name="discord" placeholder="Discord server / profile" style="width: inherit;" value="<%= decodeURI(user.bio.discord) %>"></div>
                            </div>
                            <div class="d-flex flex-row">
                              <div class="text-xxxxl lightgrey my-auto mr-2"><i class="fab fa-github" style="width: 36px;"></i></div>
                              <div class="w-100"><input type="text" class="form-control form-control-sm" name="github" placeholder="GitHub account" style="width: inherit;" value="<%= decodeURI(user.bio.github) %>"></div>
                            </div>
                            <div class="d-flex flex-row">
                              <div class="text-xxxxl lightgrey my-auto mr-2"><i class="fab fa-spotify" style="width: 36px;"></i></div>
                              <div class="w-100"><input type="text" class="form-control form-control-sm" name="spotify" placeholder="Spotify playlist" style="width: inherit;" value="<%= decodeURI(user.bio.spotify) %>"></div>
                            </div>
                            <div class="d-flex flex-row">
                              <div class="text-xxxxl lightgrey my-auto mr-2"><i class="fab fa-youtube" style="width: 36px;"></i></div>
                              <div class="w-100"><input type="text" class="form-control form-control-sm" name="youtube" placeholder="YouTube channel / playlists" style="width: inherit;" value="<%= decodeURI(user.bio.youtube) %>"></div>
                            </div>
                            <div class="d-flex flex-row">
                              <div class="text-xxxxl lightgrey my-auto mr-2"><i class="fas fa-link" style="width: 36px;"></i></div>
                              <div class="w-100"><input type="text" class="form-control form-control-sm" name="custom1" placeholder="Custom link 1" style="width: inherit;" value="<%= decodeURI(user.bio.custom1) %>"></div>
                            </div>
                            <div class="d-flex flex-row">
                              <div class="text-xxxxl lightgrey my-auto mr-2"><i class="fas fa-link" style="width: 36px;"></i></div>
                              <div class="w-100"><input type="text" class="form-control form-control-sm" name="custom2" placeholder="Custom link 2" style="width: inherit;" value="<%= decodeURI(user.bio.custom2) %>"></div>
                            </div>
                            <input type="hidden" id="findmeon" name="findmeon" value="#">
                          </div>
                          <div class="d-flex flex-row-reverse w-100 mb-1">
                            <button class="btn btn-sm btnxs btn-primary ml-2 mb-1" type="submit">Update</button>
                          </div>
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        </form>
                      </div>
                      <br>
                    </div>
                  </div>
                <% } %>
              </div>
              <div class="d-flex flex-column px-1 mobilepad">
                <div class="info1">
                  <% if(currentUser && match){ %>
                    <strong class="info-size mt-2">Personal info:</strong>
                    <div class="info30">
                      <button id="edit-account-info" onclick="toggle_display('personal_info_form_div');" class="btn btn-sm dropdown-toggle floatright"><i class="fas fa-edit"></i></button>
                    </div>
                  <% } %>
                  <div class="info1">
                    <% if(currentUser && (match || user.userKeys.house)){ %>
                      <% if(user.userKeys.house){ %>
                        House: <span class="info30">
                          <% if(!user.userKeys.college){ %>
                            <a class="lightgrey2">
                          <% } else{ %>
                            <a href="/all_students/colleges/<%= user.userKeys.college %>?house=<%= user.userKeys.house %>">
                          <% } %>
                            <%= user.userKeys.house %>
                          </a>
                        </span>
                        <br>
                      <% } %>
                    <% } %>
                    <% if(currentUser && (match || user.userKeys.hostel)){ %>
                      <% if(user.userKeys.hostel){ %>
                        Hostel: <span class="info30">
                          <% if(!user.userKeys.college){ %>
                            <a class="lightgrey2">
                          <% } else{ %>
                            <a href="/all_students/colleges/<%= user.userKeys.college %>?hostel=<%= user.userKeys.hostel %>">
                          <% } %>
                            <%= user.userKeys.hostel %>
                          </a>
                        </span>
                        <br>
                      <% } %>
                    <% } %>
                    <% if(currentUser && (match || user.userKeys.mess)){ %>
                      <% if(user.userKeys.mess){ %>
                        Mess: <span class="info30">
                          <% if(!user.userKeys.college){ %>
                            <a class="lightgrey2">
                          <% } else{ %>
                            <a href="/all_students/colleges/<%= user.userKeys.college %>?mess=<%= user.userKeys.mess %>">
                          <% } %>
                            <%= user.userKeys.mess %>
                          </a>
                        </span>
                        <br>
                      <% } %>
                    <% } %>
                    <% if(currentUser && (match || user.userKeys.school)){ %>
                      High School: <span class="info30">
                        <% if(!user.userKeys.college){ %>
                          <a class="lightgrey2">
                        <% } else{ %>
                          <a href="/all_students/colleges/<%= user.userKeys.college %>?school=<%= user.userKeys.school %>">
                        <% } %>
                          <%= user.userKeys.school %>
                        </a>
                      </span>
                      <br>
                    <% } %>
                    <% if(currentUser && (match || user.userKeys.hometown)){ %>
                      Home Town: <span class="info30">
                        <% if(!user.userKeys.college){ %>
                          <a class="lightgrey2">
                        <% } else{ %>
                          <a href="/all_students/colleges/<%= user.userKeys.college %>?hometown=<%= user.userKeys.hometown %>">
                        <% } %>
                          <%= user.userKeys.hometown %>
                        </a>
                      </span>
                      <br>
                    <% } %>
                    <% if(currentUser && (match || user.userKeys.birthdate)){ %>
                      Birthday: <span class="info30">
                        <% if(!user.userKeys.college){ %>
                          <a class="lightgrey2">
                        <% } else{ %>
                          <a href="#">
                        <% } %>
                          <% if(user.userKeys.birthdate != null){ %>
                            <%= moment(user.userKeys.birthdate).format('MMM Do YY'); %>
                          <% } %>
                        </a>
                      </span>
                    <% } %>
                  </div>
                  <% if(currentUser && match){ %>
                    <div class="info30">
                      <div id="personal_info_form_div" class="greyback mb-2">
                        <form class="pb-1 px-1" action="/users/<%= user._id %>?_method=PUT" method="POST">
                          <% if(college.houses && college.houses.length){ %>
                            <div class="pt-1 px-2">
                              <label for="house" class="sr-only">House</label>
                              <% if(!user.userKeys.house){ %>
                                <input list="house" class="form-control form-control-sm select_dark" name="userKeys[house]" title="Select from the houses avaliable in your college"
                                pattern="<% arrayToStingWithPipe(college.houses); %>" value="" placeholder="House">
                              <% } else{ %>
                                <input list="house" class="form-control form-control-sm select_dark" name="userKeys[house]" title="Select from the houses avaliable in your college"
                                pattern="<% arrayToStingWithPipe(college.houses); %>" value="<%= user.userKeys.house %>" placeholder="House">
                              <% } %>
                              <datalist id="house">
                                <% arrayToDatalistOptions(college.houses); %>
                              </datalist>
                            </div>
                          <% } %>
                          <% if(college.hostels && college.hostels.length){ %>
                            <div class="px-2">
                              <label for="hostel" class="sr-only">Hostel</label>
                              <% if(!user.userKeys.hostel){ %>
                                <input list="hostel" class="form-control form-control-sm select_dark" name="userKeys[hostel]" title="Select from the hostels avaliable in your college"
                                pattern="<% arrayToStingWithPipe(college.hostels); %>" value="" placeholder="Hostel">
                              <% } else{ %>
                                <input list="hostel" class="form-control form-control-sm select_dark" name="userKeys[hostel]" title="Select from the hostels avaliable in your college"
                                pattern="<% arrayToStingWithPipe(college.hostels); %>" value="<%= user.userKeys.hostel %>" placeholder="Hostel">
                              <% } %>
                              <datalist id="hostel">
                                <% arrayToDatalistOptions(college.hostels); %>
                              </datalist>
                            </div>
                          <% } %>
                          <% if(college.messes && college.messes.length){ %>
                          <div class="px-2">
                            <label for="mess" class="sr-only">Mess</label>
                            <% if(!user.userKeys.mess){ %>
                              <input list="mess" class="form-control form-control-sm select_dark" name="userKeys[mess]" title="Select from the messes avaliable in your college"
                              pattern="<% arrayToStingWithPipe(college.messes); %>" value="" placeholder="Mess">
                            <% } else{ %>
                              <input list="mess" class="form-control form-control-sm select_dark" name="userKeys[mess]" title="Select from the messes avaliable in your college"
                              pattern="<% arrayToStingWithPipe(college.messes); %>" value="<%= user.userKeys.mess %>" placeholder="Mess">
                            <% } %>
                            <datalist id="mess">
                              <% arrayToDatalistOptions(college.messes); %>
                            </datalist>
                          </div>
                          <% } %>
                          <div class="px-2">
                            <label for="school" class="sr-only">School</label>
                            <input type="text" id="school" class="form-control form-control-sm" name="userKeys[school]" value="<%= user.userKeys.school %>" placeholder="High School">
                            <label for="hometown" class="sr-only">HomeTown</label>
                            <input type="text" id="hometown" class="form-control form-control-sm" name="userKeys[hometown]" value="<%= user.userKeys.hometown %>" placeholder="Home Town">
                          </div>
                          <div class="input-group mt-1 px-2 date" id="datetimepicker-dateonly" data-target-input="nearest">
                            <input id="edit_birthdate" name="userKeys[birthdate]" type="text" class="form-control form-control-sm datetimepicker-input commentbox5 text-sm text-mob-sm" data-target="#datetimepicker-dateonly" placeholder="birth date (MM/DD/YYYY)" value="<%= moment(user.userKeys.birthdate).format('L'); %>" required>
                            <div class="input-group-append" data-target="#datetimepicker-dateonly" data-toggle="datetimepicker">
                              <div class="input-group-text"><i class="far fa-calendar-alt"></i></div>
                            </div>
                          </div>
                          <div class="d-flex flex-row-reverse w-100 mt-2">
                            <button class="btn btn-sm btnxs btn-primary ml-2" type="submit">Update</button>
                          </div>
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        </form>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
              <br>
              <div class="d-flex flex-column px-1 mobilepad">
                <div class="info1">
                  <strong class="info-size">Account info:</strong>
                  <div class="info30">
                    <% if(currentUser && match){ %>
                      <button id="edit-account-info" onclick="toggle_display('account_info_form_div');" class="btn btn-sm dropdown-toggle floatright"><i class="fas fa-edit"></i></button>
                    <% } %>
                  </div>
                  <% if(currentUser && match){ %>
                    <div class="info1">
                      Name: <span class="info30"><%= user.fullName %></span>
                      <% if(currentUser && match){ %>
                        <br>
                        Email: <span class="info30"><%= user.email %>
                          <% if(!user.isVerified){ %>
                            <span class="text-xs orangecolor">Not Verified</span>
                          <% } %>
                        </span>
                      <% } %>
                      <br>
                      Sex: <span class="info30"><%= user.userKeys.sex %></span>
                      <br>
                      <div class="info30">
                        <div id="account_info_form_div" class="greyback mb-2">
                          <form class="pb-1 px-1" action="/users/<%= user._id %>?_method=PUT" method="POST">
                            <div class="valign">
                              <div class="mx-2">
                                <label for="inputFirstName" class="sr-only">First Name</label>
                                <input type="text" id="inputFirstName" class="form-control form-control-sm" name="firstName" placeholder="first name" value="<%= user.firstName %>" required>
                              </div>
                              <div class="mx-2">
                                <label for="inputLastName" class="sr-only">Last Name</label>
                                <input type="text" id="inputLastName" class="form-control form-control-sm" name="lastName" placeholder="last name" value="<%= user.lastName %>">
                              </div>
                            </div>
                            <div class="px-2">
                              <div class="form-check-inline radio">
                                <% if(user.userKeys.sex == 'Male'){ %>
                                  <input id="radio-1" name="userKeys[sex]" value="Male" type="radio" required checked>
                                <% } else{ %>
                                  <input id="radio-1" name="userKeys[sex]" value="Male" type="radio" required>
                                <% } %>
                                <label for="radio-1" class="radio-label">Male</label>
                              </div>
                              <div class="form-check-inline radio">
                                <% if(user.userKeys.sex == 'Female'){ %>
                                  <input id="radio-2" name="userKeys[sex]" type="radio" value="Female" checked>
                                <% } else{ %>
                                  <input id="radio-2" name="userKeys[sex]" type="radio" value="Female">
                                <% } %>
                                <label  for="radio-2" class="radio-label">Female</label>
                              </div>
                            </div>
                            <div class="d-flex flex-row-reverse w-100 mt-2">
                              <button class="btn btn-sm btnxs btn-primary ml-2" type="submit">Update</button>
                            </div>
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          </form>
                        </div>
                      </div>
                    </div>
                  <% } %>
                </div>
                <div class="info1">
                  <% if(currentUser && match){ %>
                    Joined on: <span class="info30"><%= moment(user.createdAt).format('ll') %></span>
                    <br>
                  <% } %>
                  <% if(!match){ %>
                    Last active:
                    <% if(user.lastActive >= (new Date() - 120*1000)){ %>
                      <span class="info30 m-0 p-0">
                        <span>
                          <svg height="16" width="16">
                            <circle cx="7" cy="7" r="5" stroke="#60b769" stroke-width="1" fill="#9feca6"/>
                          </svg>
                        </span>
                        <span class="greencolor">Online</span>
                      </span>
                    <% } else if(user.lastActive >= (new Date() - 24*3600*1000)){ %>
                      <span class="info30 m-0 p-0">
                        <span>
                          <svg height="16" width="16">
                            <path d="M8 2A5 5 90 1012 8C7.315 9.994 4.631 4.802 8 2z" stroke="#f9af4a" stroke-width="1" fill="#ffdfaf"/>
                          </svg>
                        </span>
                        <span class="orangecolor"><%= moment(user.lastActive).fromNow() %></span>
                      </span>
                    <% } else{ %>
                      <span class="info30 m-0 p-0">
                        <span>
                          <svg height="16" width="16">
                            <circle cx="8" cy="7" r="5" stroke="rgba(150,150,150,0.5)" stroke-width="1" fill="transparent"></circle>
                          </svg>
                        </span>
                        <span><%= moment(user.lastActive).fromNow() %></span>
                      </span>
                    <% } %>
                  <br>
                    <% if(mutualClubs.length != 0){ %>
                      <div class="info1">Mutual clubs: <div class="info30">
                        <% var len = mutualClubs.length; for(var i=len-1;i>=0;i--){ %>
                        <% if(i==0 && i==len-1){ %>
                          <span class="m-0 p-0"><a href="/clubs/<%= mutualClubs[i]._id %>"><%= mutualClubs[i].name %></a></span>
                          <% } else if(i==len-1){ %>
                          <span class="m-0 p-0"><a href="/clubs/<%= mutualClubs[i]._id %>"><%= mutualClubs[i].name %></a>,</span>
                          <% } else if(i>0 && i<len){ %>
                          <span class="m-0 p-0"><a href="/clubs/<%= mutualClubs[i]._id %>"><%= ' '+mutualClubs[i].name %></a>,</span>
                          <% } else if(i==0){ %>
                          <span class="m-0 p-0"><a href="/clubs/<%= mutualClubs[i]._id %>"><%= ' '+mutualClubs[i].name %></a></span>
                        <% }} %>
                      </div></div>
                    <% } %>
                  <% } %>
                  <% if(match){ %>
                    <br>
                    <div class="info1">Following: <div class="info30">
                      <div id="show-following-server" class="m-0 p-0">(<%= currentUser.followingClubCount %>) <a href="#">Show ++</a></div>
                      <div id="show-following-client" class="m-0 p-0 d-none"><a href="#">Show ++</a></div>
                    </div></div>
                  <% } %>
                </div>
              </div>
            </div>
            <% if(currentUser && match){ %>
              <!-- Saved Tab -->
              <div class="tab-pane fade greyback" id="saved" role="tabpanel" aria-labelledby="saved-tab">
                <div id="delegated-heart-posts">
                  <div id="client-heart-posts" class="topnotch-left topnotch-right d-none"></div>
                  <div class="text-center">
                    <button id="load-more-heart-btn" class="btn btn-light btn-sm mt-2" type="button" value="">
                      <span id="load-more-heart-span"></span>Load
                    </button>
                  </div>
                </div>
              </div>
            <% } else if(currentUser && !match){ %>
              <!-- Chats Tab -->
              <div class="tab-pane fade greyback" id="chats" role="tabpanel" aria-labelledby="chats-tab">
                <div id="chatbox-loadingarea" class="chatbox-loadingarea3 chatbox-user" value="<%= currentUser.firstName %>">
                  <div id="user-convoId" class="user-convoId" value="<%= conversationId %>,<%= recipientId %>,<%= currentUser._id %>">
                    <div id="lastMsgBy" value="">
                      <% include ../users/chats %>
                    </div>
                  </div>
                </div>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% if(currentUser && match){ %>
    <div class="col-md-4 col-lg-3 px-2 pb-2">
      <div class="valign lb-absolute" style="padding: 0.75rem 0.5rem;">
        <div>
          <a href="/users/<%= user._id %>/settings">
            <button class="gb gb2 gb-bordered hover-fill gb-rounded border-0 px-2" title="Account settings">
              <i class="fas fa-cog mr-2"></i>Settings
            </button>
          </a>
        </div>
        <div class="ml-2">
          <% if(currentUser && !match){ %>
            <% if(wasActiveToday && wasActiveMinuteago){ %>
              <svg id="isUserInRoom" height="12" width="12">
                <circle cx="6" cy="6" r="4" stroke="#60b769" stroke-width="1" fill="#9feca6"/>
              </svg>
            <% } else if(wasActiveToday && !wasActiveMinuteago){ %>
              <svg id="isUserInRoom" height="12" width="12">
                <path d="M7.2 1.8A4.5 4.5 90 1010.8 7.2C6.5835 8.9946 4.1679 4.3218 7.2 1.8z" stroke="#f9af4a" stroke-width="1" fill="#ffdfaf"/>
              </svg>
            <% } else{ %>
              <svg id="isUserInRoom" height="12" width="12">
                <circle cx="6" cy="6" r="4" stroke="rgba(150,150,150,0.5)" stroke-width="1" fill="transparent"/>
              </svg>
            <% } %>
          <% } else{ %>
            <i class="fas fa-calendar-alt lightgrey mr-1"></i>
          <% } %>
        </div>
      </div>
    </div>
  <% } %>
</div>

<% include ../partials/footer %>

<% function arrayToStingWithComma(arr){ %>
  <% var len = arr.length; var i=0; for(i;i<len;i++){ %>
  <% if(i==0 && i==len-1){ %>
    <%= arr[i] %>
    <% }else if(i==0){ %>
    <%= arr[i]+',' %>
    <% }else if(i>0 && i<len-1){ %>
    <%= ' '+arr[i]+',' %>
    <% }else if(i=len-1){ %>
    <%= ' '+arr[i] %>
  <% }} %>
<% } %>

<% function arrayToStingWithPipe(arr){ %><% var len = arr.length; var i=0; for(i;i<len;i++){ %><% if(i==0 && i==len-1){ %><%= arr[i] %><% }else if(i==0){ %><%= arr[i]+'|' %><% }else if(i>0 && i<len-1){ %><%= arr[i]+'|' %><% }else if(i=len-1){ %><%= arr[i] %><% }} %><% } %>

<% function arrayToDatalistOptions(arr){ %>
  <% var len = arr.length; var i=0; for(i;i<len;i++){ %>
    <option value="<%=arr[i]%>">
  <% } %>
<% } %>


<%
  function rankTitle(rank){
    if(rank == 0){return 'President';}
    else if(rank == 1){return 'Admin';}
    else if(rank == 2){return 'Member';}
  }

  function rankTitle2(rank){
    if(rank == 0){return 'Pres';}
    else if(rank == 1){return 'Admn';}
    else if(rank == 2){return 'Mbr';}
  }
%>
