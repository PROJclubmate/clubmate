<% var len = posts.length; var k=0; for(k;k<len;k++){ %>
  <% if(posts[k].topic == ''){ %>
    <div class="card noborder">
  <% } else{ %>
    <div class="card noborder topic-body">
  <% } %>
    <div class="card-body">
      <div class="dropctn">
        <div class="valign">
          <div>
            <a href="/users/<%= posts[k].postAuthor.id._id %>"><img class="navdp rounded-circle mr-2" src="<%= PA_50_profilePic[k] || '/images/noUser.png' %>"></a>
          </div>
          <div class="lineheight2">
            <div>
              <span class="mobiletext2">
                <a href="/users/<%= posts[k].postAuthor.id._id %>" class="darkgrey"><strong><%= posts[k].postAuthor.id.fullName %></strong></a>
              </span>
              <em class="text-xxs lightgrey">. <%= moment(posts[k].createdAt).calendar();  %></em>
            </div>
            <div>
            <% if(0 <= rank && rank <= 2){ %>
              <div id="priv-badge<%= posts[k]._id %>" class="priv-badge badge badge-light text-xxs"><%= privacyText(posts[k].privacy) %></div>
            <% } %>
            <% if(0 <= rank && rank <= 2 && 0 <= posts[k].moderation && posts[k].moderation <= 1){ %>
              <div id="mod-badge<%= posts[k]._id %>" class="mod-badge badge badge-light text-xxs"><%= posts[k].moderation %></div>
            <% } else if(posts[k].moderation == -1){ %>
              <div id="mod-badge<%= posts[k]._id %>" class="mod-badge badge badge-danger text-xxs"><%= posts[k].moderation %></div>
            <% } %>
            <% if(posts[k].descEdit.length != 0){ %>
              <div class="badge badge-warning text-xxs">Edited</div>
            <% } %>
            </div>
          </div>
        </div>
        <% if(currentUser){ %>
          <div class="dropdown">
            <button class="btn btn-sm dropdown-toggle" type="button" data-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
            <ul class="dropdown-menu dropdown-menu-right dropbox">
              <div class="container drop-shadow1">
                <% if(0 <= rank && rank <= 1){ %>
                  <li>
                    <form class="post-vote-form valign" action="/posts/<%= posts[k]._id %>/vote" method="POST">
                      <% if(posts[k].moderation != -1){ %>
                        <button id="visibility<%= posts[k]._id %>" class="dropitems link-button moderation text-sm" name="visibility" value="-1" title="Post moderation" type="submit">Visibility(Hide)</button>
                      <% } else if(posts[k].moderation == -1){ %>
                        <button id="visibility<%= posts[k]._id %>" class="dropitems link-button moderation text-sm" name="visibility" value="1" title="Post moderation" type="submit">Visibility(Show)</button>
                      <% } %>
                    </form>
                  </li>
                <% } %>
                <li><a class="dropitems text-sm" href="#">Help ?</a></li>
                <% if(currentUser._id.equals(posts[k].postAuthor.id._id)){ %>
                  <hr>
                  <li>
                    <button class="dropitems link-button text-sm red" href="#delPostModalclubs<%= posts[k].postClub %>posts<%= posts[k]._id %>" data-toggle="modal">Delete post</button>
                  </li>
                <% }; %>
              </div>
            </ul>
            <% if(currentUser._id.equals(posts[k].postAuthor.id._id)){ %>
              <!-- Modal HTML -->
              <div id="delPostModalclubs<%= posts[k].postClub %>posts<%= posts[k]._id %>" class="fixed-padding modal fade">
                <div class="modal-dialog modal-confirm">
                  <div class="modal-content">
                    <div class="d-flex">
                      <span class="icon-box">
                        <i class="fas fa-exclamation-triangle text-xxxl"></i>
                      </span>              
                      <span class="my-auto"><h5 class="modal-title">Are you sure?</h5></span>
                      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    </div>
                    <div>
                      <p>Do you really want to delete this post? This cannot be undone.</p>
                    </div>
                    <div class="my-2">
                      <button type="button" class="btn btn-secondary btn-sm mr-1" data-dismiss="modal">Cancel</button>
                      <form class="delete-form inline" action="/clubs/<%= posts[k].postClub %>/posts/<%= posts[k]._id %>?_method=DELETE" method="POST">
                        <button class="btn btn-danger btn-sm ml-1" type="submit">Delete</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            <% }; %>
          </div>
        <% }; %>
      </div>
    </div>
    <!-- POSTS WITHOUT TOPIC -->
    <% if(posts[k].topic == ''){ %>
      <% if(posts[k].image){ %>
        <a href="/clubs/<%= posts[k].postClub %>/posts/<%= posts[k]._id %>">
          <div><img class="card-img-top postimg" src="<%= posts[k].image %>"></div>
        </a>
        <div class="card-body">
          <p class="truncate nothing mobiletext linewrap"><%= posts[k].description %></p>
        </div>
        <hr>
      <% } else{ %>
        <div class="nounderline nothing card-body2">
          <a href="/clubs/<%= posts[k].postClub %>/posts/<%= posts[k]._id %>">
            <span class="truncate2 mobiletext linewrap nolink"><%= posts[k].description %></span>
          </a>
        </div>
        <hr>
      <% } %>
      <div class="card-body3">
        <form class="post-vote-form valign" action="/posts/<%= posts[k]._id %>/vote" method="POST">
          <div class="valign">
            <% if(currentUser){ %>
              <% if(hasVote[k] == 1){ %>
                <span class="d-flex mr-1"> 
                  <button id="like-btn<%= posts[k]._id %>" class="vote likebtn" name="like" type="submit" value="like" title="Like"><i class="fas fa-thumbs-up greencolor"></i></button>
                </span>
                <span id="like-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm greencolor"><%= posts[k].likeCount %></span>
                <span class="d-flex ml-2 mr-1">
                  <button id="dislike-btn<%= posts[k]._id %>" class="vote dislikebtn" name="dislike" type="submit" value="dislike" title="Dislike"><i class="far fa-thumbs-down"></i></button>
                </span>
                <span id="dislike-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm"><%= posts[k].dislikeCount %></span>
              <% } else if(hasVote[k] == -1){ %>
                <span class="d-flex mr-1"> 
                  <button id="like-btn<%= posts[k]._id %>" class="vote likebtn" name="like" type="submit" value="like" title="Like"><i class="far fa-thumbs-up"></i></button>
                </span>
                <span id="like-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm"><%= posts[k].likeCount %></span>
                <span class="d-flex ml-2 mr-1">
                  <button id="dislike-btn<%= posts[k]._id %>" class="vote dislikebtn" name="dislike" type="submit" value="dislike" title="Dislike"><i class="fas fa-thumbs-down blackcolor"></i></button>
                </span>
                <span id="dislike-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm blackcolor"><%= posts[k].dislikeCount %></span>
              <% } else if(hasVote[k] == 0 || hasVote[k] == 3){ %>
                <span class="d-flex mr-1"> 
                  <button id="like-btn<%= posts[k]._id %>" class="vote likebtn" name="like" type="submit" value="like" title="Like"><i class="far fa-thumbs-up"></i></button>
                </span>
                <span id="like-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm"><%= posts[k].likeCount %></span>
                <span class="d-flex ml-2 mr-1">
                  <button id="dislike-btn<%= posts[k]._id %>" class="vote dislikebtn" name="dislike" type="submit" value="dislike" title="Dislike"><i class="far fa-thumbs-down"></i></button>
                </span>
                <span id="dislike-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm"><%= posts[k].dislikeCount %></span>
              <% } %>
            <% } else{ %>
              <span class="d-flex mr-1"> 
                <button id="like-btn<%= posts[k]._id %>" class="vote" name="like" type="submit" value="like" title="Like"><i class="fas fa-thumbs-up"></i></button>
              </span>
              <span id="like-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm"><%= posts[k].likeCount %></span>
              <span class="d-flex ml-2 mr-1">
                <button id="dislike-btn<%= posts[k]._id %>" class="vote" name="dislike" type="submit" value="dislike" title="Dislike"><i class="fas fa-thumbs-down"></i></button>
              </span>
              <span id="dislike-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm"><%= posts[k].dislikeCount %></span>
            <% } %>
          </div>
        
          <div class="valign">
            <% if(currentUser){ %>
              <% if(hasVote[k] == 3){ %>
                <span id="heart-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm redcolor"><%= posts[k].heartCount %></span>
                <span><button id="heart-btn<%= posts[k]._id %>" class="vote heartbtn" name="heart" type="submit" value="heart" title="Heart"><i class="fas fa-heart redcolor"></i></button></span>
              <% } else if(hasVote[k] == 0 || hasVote[k] == 1 || hasVote[k] == -1){ %>
                <span id="heart-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm"><%= posts[k].heartCount %></span>
                <span><button id="heart-btn<%= posts[k]._id %>" class="vote heartbtn" name="heart" type="submit" value="heart" title="Heart"><i class="far fa-heart"></i></button></span>
                <% } %>
                <!-- Moderation -->
                <% if(0 <= rank && rank <= 2 && posts[k].moderation == 1){ %>
                  <span>
                    <button id="moderation<%= posts[k]._id %>" class="moderation btn btnxxs btn-light noshadow text-sm ml-2" name="published" value="0" title="Post moderation" type="submit">Exclusive</button>
                  </span>
                <% } else if(0 <= rank && rank <= 2 && posts[k].moderation == 0){ %>
                  <span>
                    <button id="moderation<%= posts[k]._id %>" class="moderation btn btnxxs btn-info noshadow text-sm ml-2" name="exclusive" value="1" title="Post moderation" type="submit">Published</button>
                  </span>
                <% } %>
                  <span class="nodisplay" id="modVisibility<%= posts[k]._id %>"></span>
            <% } else{ %>
              <span id="heart-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm"><%= posts[k].heartCount %></span>
              <span><button id="heart-btn<%= posts[k]._id %>" class="vote" name="heart" type="submit" value="heart" title="Heart"><i class="fas fa-heart"></i></button></span>
            <% } %>
          </div>
        </form>
      </div>
    <% } else{ %>
      <!-- POSTS WITH TOPIC AND FURTHER DISCUSSION -->
      <div class="nounderline nothing">
        <div class="valign topic-head">
          <div class="mx-2 mb-auto">
            <h5 class="nothing topic-h5"><%= posts[k].topic %></h5>
          </div>
          <!-- UP/DOWN VOTE -->
          <div class="mx-2 mb-auto d-flex flex-column">
            <form class="d-flex flex-column post-modvote-form" action="/posts/<%= posts[k]._id %>/modvote" method="POST">
              <% if(hasModVote[k] == 1){%>
                <button id="upVote-btn<%= posts[k]._id %>" class="modvote upVotebtn bluecolor" name="upVote" type="submit" value="up" title="Upvote"><i class="fas fa-caret-up lineheight3"></i></button>
                <span id="modVote-count<%= posts[k]._id %>" class="boldtext nothing text-xs text-center bluecolor"><%= posts[k].upVoteCount - posts[k].downVoteCount %></span>
                <button id="downVote-btn<%= posts[k]._id %>" class="modvote downVotebtn" name="downVote" type="submit" value="down" title="Downvote"><i class="fas fa-caret-down lineheight3"></i></button>
              <% } else if(hasModVote[k] == -1){ %>
                <button id="upVote-btn<%= posts[k]._id %>" class="modvote upVotebtn" name="upVote" type="submit" value="up" title="Upvote"><i class="fas fa-caret-up lineheight3"></i></button>
                <span id="modVote-count<%= posts[k]._id %>" class="boldtext nothing text-xs text-center orangecolor"><%= posts[k].upVoteCount - posts[k].downVoteCount %></span>
                <button id="downVote-btn<%= posts[k]._id %>" class="modvote downVotebtn orangecolor" name="downVote" type="submit" value="down" title="Downvote"><i class="fas fa-caret-down lineheight3"></i></button>
              <% } else if(hasModVote[k] == 0){ %>
                <button id="upVote-btn<%= posts[k]._id %>" class="modvote upVotebtn" name="upVote" type="submit" value="up" title="Upvote"><i class="fas fa-caret-up lineheight3"></i></button>
                <span id="modVote-count<%= posts[k]._id %>" class="boldtext darkgrey nothing text-xs text-center"><%= posts[k].upVoteCount - posts[k].downVoteCount %></span>
                <button id="downVote-btn<%= posts[k]._id %>" class="modvote downVotebtn" name="downVote" type="submit" value="down" title="Downvote"><i class="fas fa-caret-down lineheight3"></i></button>
              <% } %>
            </form>
          </div>
        </div>
        <% if(posts[k].image){ %>
          <div class="truncate nothing mobiletext linewrap card-body3"><%= posts[k].description %></div>
          <a href="/clubs/<%= posts[k].postClub %>/posts/<%= posts[k]._id %>">
            <div><img class="card-img-top postimg" src="<%= posts[k].image %>"></div>
          </a>
        <% } else{ %>
          <a href="/clubs/<%= posts[k].postClub %>/posts/<%= posts[k]._id %>">
            <div class="truncate2 card-body3 mobiletext linewrap nolink"><%= posts[k].description %></div>
          </a>
        <% } %>
      </div>
      <hr>
      <!-- Vote bar -->
      <div class="card-body3">
        <form class="post-vote-form valign" action="/posts/<%= posts[k]._id %>/vote" method="POST">
          <div class="valign">
            <span class="lightgrey text-sm"><strong><%= posts[k].subpostsCount %></strong> subPosts</span>
          </div>
          <div class="valign">
            <% if(currentUser){ %>
              <% if(hasVote[k] == 3){ %>
                <span id="heart-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm redcolor"><%= posts[k].heartCount %></span>
                <span><button id="heart-btn<%= posts[k]._id %>" class="vote heartbtn" name="heart" type="submit" value="heart" title="Heart"><i class="fas fa-heart redcolor"></i></button></span>
              <% } else if(hasVote[k] == 0 || hasVote[k] == 1 || hasVote[k] == -1){ %>
                <span id="heart-count<%= posts[k]._id %>" class="boldtext lightgrey nothing text-sm"><%= posts[k].heartCount %></span>
                <span><button id="heart-btn<%= posts[k]._id %>" class="vote heartbtn" name="heart" type="submit" value="heart" title="Heart"><i class="far fa-heart"></i></button></span>
                <% } %>
                  <span class="nodisplay" id="modVisibility<%= posts[k]._id %>"></span>
            <% } else{ %>
              <span><button id="heart-btn<%= posts[k]._id %>" class="vote heartbtn" name="heart" type="submit" value="heart" title="Heart"><i class="far fa-heart"></i></button></span>
            <% } %>
          </div>
        </form>
      </div>
    <% } %>
  </div>
  <!-- COMMENTS -->
  <% if(posts[k].topic == ''){ %>
    <div class="card noborder indexcard2">
      <% if(posts[k].commentsCount != 0){ %>
        <div class="card-body3">
          <% var z=1; var buckets = posts[k].commentBuckets; var len1 = buckets.length; var i; for(i=len1-1;i>=0;i--){%>
            <% var comments = buckets[i].comments; var len2 = comments.length; var j; for(j=len2-1;j>=0;j--){%>
            <% if(z<=2){ %>
              <div class="valign">
                <div class="wordwrap">
                  <span><a href="/users/<%= comments[j].commentAuthor.id._id %>" class="black"><span class="nothing mobiletext boldtext"><%= comments[j].commentAuthor.authorName %></span></a>
                  </span>
                  <span class="mobiletext"><%= comments[j].text %></span>
                </div>
                <div class="d-flex flex-row-reverse valign mb-auto pt-2">
                  <span class="text-xs text-center boldtext lightgrey"><%= comments[j].upvotesCount %></span>
                <% if(currentUser && comments[j].commentAuthor.id._id.equals(currentUser._id)){ %>
                  <span class="dropdown">
                    <button class="btn btn-sm dropdown-toggle valign" type="button" data-toggle="dropdown"><i class="fas fa-ellipsis-v text-xxs"></i></button>
                    <ul class="dropdown-menu dropdown-menu-right dropbox">
                      <div class="container drop-shadow1">
                        <li>
                          <a class="dropitems text-sm" href="/posts/<%=posts[k]._id%>/comments/<%= buckets[i]._id %>/<%=comments[j]._id%>/edit">Edit comment</a>
                        </li>
                        <hr>
                        <li>
                          <button class="dropitems link-button red text-sm" href="#delCommentModalposts<%=posts[k]._id%>comments<%= buckets[i]._id %><%=comments[j]._id%>" data-toggle="modal">Delete comment</button>
                        </li>
                      </div>
                    </ul>
                  </span>
                  <!-- Modal HTML -->
                  <div id="delCommentModalposts<%=posts[k]._id%>comments<%= buckets[i]._id %><%=comments[j]._id%>" class="fixed-padding modal fade">
                    <div class="modal-dialog modal-confirm">
                      <div class="modal-content">
                        <div class="d-flex">
                          <span class="icon-box">
                            <i class="fas fa-exclamation-triangle text-xxxl"></i>
                          </span>              
                          <span class="my-auto"><h5 class="modal-title">Are you sure?</h5></span>
                          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        </div>
                        <div>
                          <p>Do you really want to delete this comment? This cannot be undone.</p>
                        </div>
                        <div class="my-2">
                          <button type="button" class="btn btn-secondary btn-sm mr-1" data-dismiss="modal">Cancel</button>
                          <form class="delete-form inline text-sm" action="/posts/<%=posts[k]._id%>/comments/<%= buckets[i]._id %>/<%=comments[j]._id%>?_method=DELETE" method="POST">
                            <button class="btn btn-danger btn-sm ml-1" type="submit">Delete</button>
                          </form>
                        </div>
                      </div>
                    </div>
                  </div>
                <% } %>
                </div>
              </div>
            <% z++;} %>
            <% } %>
          <% } %>
        </div>
        <hr>
      <% }; %>
      <div class="card-body3">
        <div class="valign">
          <div class="mb-auto">
            <% if(currentUser){ %>
              <a href="/users/<%= currentUser._id %>"><span><img class="postdp rounded-circle" src="<%= CU_50_profilePic || '/images/noUser.png' %>"></span></a>
            <% } else{ %>
              <span><img class="postdp rounded-circle" src="<%= '/images/noUser.png' %>"></span>
            <% }%>
          </div>
          <div class="commentdiv">
            <form action="/posts/<%= posts[k]._id %>/comments" method="POST">
              <div class="input-group">
                <input onclick="block_display('commentbtn<%= posts[k]._id %>');" id="commentbox" class="commentbox text-sm form-control form-control-sm" type="text" name="text" placeholder="Write a comment" required>
              </div>
              <div class="d-flex flex-row-reverse">
                <button class="btn btn-sm btn-success commentbtn commentbtn<%= posts[k]._id %> btnxs ml-2 mt-2">Submit</button>
                <button onclick="none_display('commentbtn<%= posts[k]._id %>'); clear_text();" class="btn  btn-secondary commentbtn commentbtn<%= posts[k]._id %> btnxs text-sm mt-2" type="button">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  <% }; %>
<% }; %>